---
title: "Supplementary Materials"
author: "Peter J. Kohler and Alasdair D. F. Clarke"
date:
output: bookdown::html_document2
---

I have set `echo=FALSE` so that most of the code chunks will not display. Please refer to the .Rmd file for source code.

```{r setup, include=FALSE}

library(bookdown)
library(tidyverse)
library(brms)
library(tidybayes)
library(ggridges)
library(latex2exp)
library(see)
library(ggthemes)
library(patchwork)
library(magick)

knitr::opts_chunk$set(echo = FALSE, message=FALSE, fig.align='center')

# specify some colours to use in the plots
v_cols <- ggthemes::ptol_pal()(6)

# read in some helper functions that will be used later
source("scripts/helper_functions.R")
```

# Loading packages and importing data

##  Packages

Details of packages, etc, are given below.

```{r}
sessionInfo()
```

```{r}
# Use multiple cores and set number of iterations. 
options(mc.cores = parallel::detectCores())
n_iter <- 10000

# make empty lists to store things in
my_models <- list()
my_samples <- list()
comp_summary <- list()
subgroup_comp <- list()
```

## Import Data

Here we import our data and make some summary plots.

### EEG Data

Importing the primary EEG data set. This is odd-harmonic filtered data from region-of-interest consisting of six electrodes over occipital cortex.

```{r, fig.cap = "RMS data from two of the wallpaper groups, P2 and P4M. Odd harmonics are shown in A and B, while even harmonic data are shown in C and D, and occipital and parietal regions of interest are shown in dark nad light gray, respectively. The two groups elicit very different response amplitudes for odd harmonics over occipital cortex, but for even harmonics those differences are much less pronounced."}
plt <- cowplot::ggdraw() +
  cowplot::draw_image("../figures/occTopo_merged.png")
print(plt)

```

```{r eeg_import}
fl <- "rms_Occ_Odd.csv"

# set column types
my_cols <- cols(
  .default = col_double(),
  Row = col_character()
)

#import
read_csv(paste("data/", fl, sep = ""), col_types = my_cols) %>%
  rename(wg = "Row") %>%
  gather("subject", "rms", -wg) %>%
  glimpse() -> d_eeg 
```
 
It's clearly skewed, and negative display duration are impossible, so will fit a `glm` with `family = 'lognormal'`.

```{r cache=TRUE, fig.cap = "Data are the root-mean-squaured (rms) over the odd-harmonic filtered waveforms."}
d_eeg %>% ggplot(aes(x = rms)) + 
    geom_histogram(binwidth = 0.2, fill = "skyblue", colour = "black") +
    theme_lucid()
```

### Threshold Data

Here we import that data and select the columns that we're interested in. Threshold gives the required display duration (in seconds) for the two stimuli to allow for accurate discrimination. 

```{r threshold_import}
fl <- "thresholds"

my_cols_threshold <- cols(
  person = col_character(),
  group = col_character(),
  staircase = col_double(),
  threshold = col_double(),
  log_threshold = col_double()
)

read_csv("../Experiment/process_results/thresholds.csv", col_types = my_cols_threshold) %>%
  select(subject = "person", wg = "group", threshold) %>%
  glimpse() -> d_dispthresh 

rm(my_cols_threshold)
```
 
As above, a summary of the data.

```{r, fig.cap="Histogram of the display duration thresholds."}
d_dispthresh %>% ggplot(aes(x = threshold)) + 
    geom_histogram(binwidth = 0.2, fill = "skyblue", colour = "black") +
    theme_lucid()
```

Again, we have a skewed distribution, so will fit with `family = 'lognormal'`.

### Control Data

In addition to the primary EEG data set, we are also importing two control data sets which are (a) even harmonic data from the same occipital electrodes, and (b) odd harmonic data from six parietal electrodes (see Figure 1.1 and the main paper).

```{r import_control}

fl <- "rms_Occ_Even.csv"

read_csv(paste("data/", fl, sep = ""), col_types = my_cols) %>%
  rename(wg = "Row") %>%
  gather("subject", "rms", -wg) -> d_eeg_occ_even

fl <- "rms_Par_Odd.csv"

read_csv(paste("data/", fl, sep = ""), col_types = my_cols) %>%
  rename(wg = "Row") %>%
  gather("subject", "rms", -wg) -> d_eeg_par_odd

rm(my_cols, fl)
```

# Bayesian Analysis 

Here are the details of the Bayesian multi-level modelling. Our general approach is:

*  Use weakly-informative priors.
*  Fit a multi-level model using the lognormal distribution.
  + independent variable (wallpaper group) and one dependent variable (rms or threshold).
  + maximal random effect structure.
* Check model fit (r̂ statistics and trace plots).
* Extract mcmc samples from the posterior distributions.
* Use these samples to estimate the difference between sub- and super-groups.

## Define Priors

In this section we will specify some priors. We then then use a prior-predictive check to assess whether the prior is reasonable or not (i.e., on the same order of magnitude as our measurements).

### Fixed Effects

Our independent variable is a categorical factor with 16 levels. We will drop the intercept from our model and instead fit a coefficent for each factor level ($y \sim x - 0$). As our dependant variable will be log-transformed, we can use the priors below: 

```{r, echo = TRUE}
prior <- c(
  set_prior("normal(0,2)", class = "b"),    
  set_prior("cauchy(0,2)", class = "sigma"))
```

### Group-level Effects

We will keep the default weakly informative priors for the group-level (‘random’) effects. From the brms documentation:

> [...] restricted to be non-negative and, by default, have a half student-t prior with 3 degrees of freedom and a scale parameter that depends on the standard deviation of the response after applying the link function. Minimally, the scale parameter is 10. This prior is used (a) to be only very weakly informative in order to influence results as few as possible, while (b) providing at least some regularization to considerably improve convergence and sampling efficiency.

### Prior Predictive Check

Now we can specify our Bayesian multi-level model and priors. Note that as we are using  `sample_prior = 'only'`, the model will not learn anything from our data.  

```{r eeg_prior_pred_check, cache=TRUE, echo=TRUE}
m_prior <- brm(data = d_eeg, 
  rms ~ wg-1 + (1|subject),
  family = "lognormal", 
  prior = prior, 
  iter = n_iter ,
  sample_prior = 'only')
```

We can use this model to generate data.

```{r, fig.cap="The density plot shows the distribution of the empirical data, while the blue line shows the 66% and 95% prediction intervals."}
prior_samples <- get_model_samples(m_prior) 

# Tidy up a little
prior_predictions <- get_model_predictions(prior_samples)%>% glimpse()

# # And now plot
p1 <- plot_model_output(prior_predictions, d_eeg,
                   "odd-harmonic data from \noccipital electrodes", "cornflowerblue", "log(rms)")

p2 <- plot_model_output(prior_predictions, d_dispthresh,
                   "display duration threshold data", "cornflowerblue", "log(ms)")

# draw pot
plt <- p1 + p2
plt + plot_annotation(title = 'Prior Predictive Checks')
```

We can see that i) our priors are relatively weak as the predictions span several orders of magnitide, and ii) our empirical data falls within this range. 


## Compute Posterior 

### Fit Model to EEG Data

We will now fit the model to the data.

```{r eeg_fit_model, cache=TRUE}
m_eeg <- brm(data = d_eeg, 
             rms ~ wg-1 + (1|subject),
             family = "lognormal", 
             prior = prior, iter = n_iter,
             control = list(adapt_delta = 0.99))

summary(m_eeg)

# Also fit to display duration data so I can display both models together

m_threshold <- brm(data = d_dispthresh, 
                   threshold ~ wg-1 + (1|subject),
                   family = "lognormal", 
                   prior = prior, iter = n_iter,
                   control = list(adapt_delta = 0.99))
```

We will now look at the model's predicts for the average participant (i.e, ignoring the random intercepts). 

```{r, fig.cap ="The density plot shows the distribution of the empirical data, while the blue line shows the 66% and 95% prediction intervals."}

 # Extract samples from model
my_samples$eeg <- get_model_samples(m_eeg)
my_samples$threshold <- get_model_samples(m_threshold)
 
 # Tidy up a little
 my_models$eeg <- get_model_predictions(my_samples$eeg)
 my_models$threshold <- get_model_predictions(my_samples$threshold)
 
 # Plot
plt1 <- plot_model_output(
  my_models$eeg, d_eeg,
  "odd-harmonic data from \noccipital electrodes",
  "orangered3", 
  "log(rms)")

plt2 <- plot_model_output(
  my_models$threshold, d_dispthresh, 
  "Psychophysical Data", 
  "orangered3", 
  "threshold (ms)")

plt1 + plt2 + plot_annotation(title = 'Model Fits:')

```

### Fit Model to Psychophysical Data

We will now fit the model to the data.

```{r threshold_fit_model, cache=TRUE, echo=FALSE}
summary(m_threshold)
```

### EEG Control Data

We will also fit models to the control data. As we can see from Figure 2.4, the group differences are much smaller. 

```{r fig.cap="The density plot shows the distribution of the empirical data, while the blue line shows the 66% and 95% prediction intervals."}

m_eeg_par_odd <- brm(data = d_eeg_par_odd, 
                     rms ~ wg-1 + (1|subject),
                     family = "lognormal", 
                     prior = prior, iter = n_iter,
                     control = list(adapt_delta = 0.99))

my_samples$par_odd <- get_model_samples(m_eeg_par_odd)
my_models$par_odd <- get_model_predictions(my_samples$par_odd)
plt1 <- plot_model_output(my_models$par_odd, d_eeg_par_odd, 
                  "odd-harmonic data from \nparietal electrodes", "orangered3", "threshold (ms)")


m_eeg_occ_even <- brm(data = d_eeg_occ_even, 
                      rms ~ wg-1 + (1|subject),
                      family = "lognormal", 
                      prior = prior, iter = n_iter,
                      control = list(adapt_delta = 0.99))

# Extract samples from model
my_samples$occ_even <- get_model_samples(m_eeg_occ_even)
my_models$occ_even <- get_model_predictions(my_samples$occ_even)
plt2 <- plot_model_output(my_models$occ_even, d_eeg_occ_even, 
                  "even-harmonic data from \noccipital electrodes", "orangered3", "threshold (ms)")

plt1 + plt2 + plot_annotation(title = 'Model Fits for the ')
``` 

# Subgroup Comparisons

We will now compute the difference between sub- and super-groups. 
  
```{r subgroup_comparisons, cache=TRUE}
source("scripts/get_subgroup_comparisons.R")

subgroup_comp$eeg <- get_subgroup_comparisons(my_samples$eeg, 2*n_iter)
subgroup_comp$threshold <- get_subgroup_comparisons(my_samples$threshold, 2*n_iter)
subgroup_comp$occ_even <- get_subgroup_comparisons(my_samples$occ_even, 2*n_iter)
subgroup_comp$par_odd  <- get_subgroup_comparisons(my_samples$par_odd,  2*n_iter)
```

## Primary EEG Data

Finally, we calculate the probability that the RMS difference between subgroup and supergroup is larger than zero given the data. This information is then binned so we can colour in the posterior density plots.

```{r define_comparison_summary_function}
comparison_summary <- function(subgroup_comp_dat, greater, measurement_lab) {
  # compute probabilties
  subgroup_comp_dat %>%
    group_by(key, index, normal) %>%
    summarise(
      mean_value = mean(value),
      prob_one_tailed = if_else(greater == TRUE, mean(value > 0), mean(value < 0)))  %>%
    mutate(
      measurement = measurement_lab,
      index_labs = as.numeric(as.factor(index)),
      lab_cols = v_cols[index_labs],
      prob_cat = cut(prob_one_tailed, c(0, 0.5, 0.75, 0.9, 0.99, 1))) -> comp_summary_dat
  
  return(comp_summary_dat)
}
```

Now we will use it!
  
```{r, fig.height=8, fig.cap="Distributions of the difference in mean log(rms) between sub- and super-groups. The index of each relationship is indicated by the colour of the y-axis label. The fill of the density plots indicated the probability of the difference being greater than zero."}
# compute probabilties
comp_summary$eeg <- comparison_summary(subgroup_comp$eeg, TRUE, 'rms')

subgroup_comp$eeg <- full_join(
  subgroup_comp$eeg, 
  comp_summary$eeg, 
  by = c("key", "index", "normal"))

# Finally, plot everything:
p1 <- plot_comparisons(
  filter(subgroup_comp$eeg, index == 2),
  filter(comp_summary$eeg, index == 2), 
  1)

p2 <-plot_comparisons(
  filter(subgroup_comp$eeg, index != 2),
  filter(comp_summary$eeg, index != 2), 
  2)

both_plts <- cowplot::plot_grid(p1, p2, ncol = 2, align="hv")
both_plts
```

## Psychophysical Data

We can do the same for the display duration thresholds from our psychophysics experiment. Here we are looking for the opposite effect, namely that display larger are larger for subgroups than for supergroups (see main paper), so we calculate the probability that differences in duration are smaller than zero. 

```{r ,fig.height=8, fig.cap="Distributions of the difference in mean log display duration threshold between sub- and super-groups. The index of each relationship is indicated by the colour of the y-axis label. The fill of the density plots indicated the probability of the difference being less than zero."}

# compute probabilties
comp_summary$threshold <- comparison_summary(subgroup_comp$threshold, FALSE, 'threshold')

subgroup_comp$threshold <- full_join(
  subgroup_comp$threshold, 
  comp_summary$threshold, 
  by = c("key", "index", "normal"))

# Finally, plot everything:
p1 <- plot_comparisons(
  filter(subgroup_comp$threshold, index == 2),
  filter(comp_summary$threshold, index == 2), 
  1, TRUE)

p2 <- plot_comparisons(
  filter(subgroup_comp$threshold, index != 2),
  filter(comp_summary$threshold, index != 2), 
  2, TRUE)

both_plts <- cowplot::plot_grid(p1, p2, ncol = 2, align="hv")
both_plts
```

## Control EEG Data

We will now do exactly the same with the control data (odd harmonic data from parietal electrodes and even harmonic data from occipital electrodes)

```{r fig.height=8, echo = FALSE, fig.cap="Distributions of the difference in mean log(rms) between sub- and super-groups. The index of each relationship is indicated by the colour of the y-axis label. The fill of the density plots indicated the probability of the difference being greater than zero."}

# compute probabilties
comp_summary$occ_even <- comparison_summary(subgroup_comp$occ_even, TRUE, 'rms') 

subgroup_comp$occ_even <- full_join(
  subgroup_comp$occ_even, 
  comp_summary$occ_even, 
  by = c("key", "index", "normal"))

p1 <- plot_comparisons(
  filter(subgroup_comp$occ_even, index == 2),
  filter(comp_summary$occ_even, index == 2), 
  1)
p2 <- plot_comparisons(
  filter(subgroup_comp$occ_even, index != 2),
  filter(comp_summary$occ_even, index != 2), 
  2)

both_plts <- cowplot::plot_grid(p1, p2, ncol = 2, align="hv") 
both_plts + plot_annotation(title = 'Odd harmonic data from parietal electrodes')

# compute probabilties
comp_summary$par_odd <- comparison_summary(subgroup_comp$par_odd, TRUE, 'rms') 

subgroup_comp$par_odd <- full_join(
  subgroup_comp$par_odd, 
  comp_summary$par_odd, 
  by = c("key", "index", "normal"))

p1 <- plot_comparisons(
  filter(subgroup_comp$par_odd, index == 2),
  filter(comp_summary$par_odd, index == 2), 
  1)
p2 <- plot_comparisons(
  filter(subgroup_comp$par_odd, index != 2),
  filter(comp_summary$par_odd, index != 2), 
  2)

both_plts <- cowplot::plot_grid(p1, p2, ncol = 2, align="hv")
both_plts + plot_annotation(title = 'Even harmonic data from occipital electrodes')
```

## Summary

We can summarise the subgroup comparison plots above by plotting ROC curves for each of our four measurements (Figure 3.5).

```{r, fig.cap="This figure shows how many of our 64 comparisons are classed as having a greater-than-zero difference (less-than-zero for the display durations) for difference thresholds. between 0.5 an 1.0."}

count_comparisons <- function(comparisons, p) {
  x <- sum(comparisons$prob_one_tailed >= p)
  return(x)
}

df <- tibble()

for (p in seq(0.5, 0.99, 0.01)) {

  df <- bind_rows(df, map_dbl(comp_summary,  count_comparisons, p))
}

df$p <- seq(0.5, 0.99, 0.01)

df %>% gather("measurement", "number", -p) %>%
  mutate(proportion = number/64) %>%
  ggplot(aes(x = p, y = proportion, colour = measurement)) + geom_point() + geom_path() +
  theme_minimal() + ggthemes::scale_color_ptol(labels = c("primary EEG", "sensor control EEG", "harmonic control EEG", "psychophysical threshold")) +
  xlab("probability of difference given data") + ylab("proportion of subgroup comparisons")
```

If we take p=0.95 as our cut-off, we can see that the subgroup relations are preserved in 56/64 = 87.5% and 49/64 = 76.6% of the comparisons for the primary EEG and display durations repectively. This compares to the $32/64= 50.0% and 22/64 = 34.4% for the control EEG conditions. 

# Additional Analysis

## Index and Normality 

Subgroup relations can be classified by their index, and by whether they are normal or not. Here we investigate the extent to which these two variables can account for the variation between the subgroup relationships. 

```{r}
my_models <- list()
comp_summary$eeg$index <- as.numeric(as.character(comp_summary$eeg$index))
comp_summary$threshold$index <- as.numeric(as.character(comp_summary$threshold$index))

my_models$eeg <- brm(data = comp_summary$eeg, mean_value ~ index * normal)
my_models$disp <- brm(data = comp_summary$threshold, mean_value ~ index * normal)
summary(my_models$eeg)
summary(my_models$disp)
```

We can see that the index of the subgroup relationship has an effect on both the difference in log(rms) and the difference in log(display duration): relationships with a higher index lead to larger differences. 

```{r, fig.cap = "The effect of index and normality on log(rms) and log(ms)."}
comp_summary$eeg %>% 
  modelr::data_grid(index, normal) %>%
  add_fitted_draws(my_models$eeg, n = 100) %>%
  mutate(model = "primary eeg") -> d_plt_eeg

comp_summary$threshold %>% 
  modelr::data_grid(index, normal) %>%
  add_fitted_draws(my_models$disp, n = 100) %>%
  mutate(model = "psychophysical threshold") -> d_plt_disp

d_summary <- bind_rows(comp_summary$threshold %>% mutate(model = "psychophysical threshold"),
                       comp_summary$eeg %>% mutate(model = "primary eeg"))

bind_rows(d_plt_eeg, d_plt_disp) %>%
  ggplot(aes(x =  index, y = .value, color = as.factor(normal), group = interaction(.draw, normal))) +
  geom_line(alpha = .15) +
  facet_wrap(~ model, scales="free_y") + 
  geom_jitter(
    data = d_summary, 
    aes(x =  index, y = mean_value, colour = as.factor(normal), group = 1), width = 0.1, height = 0, alpha = 0.33) +
  theme_minimal() + 
  ggthemes::scale_colour_ptol(labels = c("non-normal", "normal")) + 
  scale_x_continuous("index", breaks = c(2,3,4,6,8,12)) +
  scale_y_continuous("value") +
  theme(panel.grid.minor = element_blank(), legend.title = element_blank()) 
```


## Correlation Between Primary EEG data and Psychophysical Thresholds

Finally, we will investigate whether there is a correlation between the our primary EEG measure (rms amplitude of odd harmonics over occipital cortex) and our display duration thresholds. As our two different measures come from different samples of participants, we are unable to do a direct comparison. However, we can use the results of the models discussed in Section 3 and check for a correlation between the predicted values of the two measures. 

```{r compare_comparisons}
bind_rows(
  select(comp_summary$eeg, measurement, key, mean_value),
  select(comp_summary$threshold, measurement, key, mean_value)) %>%
  spread(measurement, mean_value) -> d

m <- brm(data = d, threshold ~ rms)

bayes_R2(m)
```

We can see that although the correlation is relatively weak, our confidence interval indicates that we can be reasonably positive that $R^2>0$ (i.e, 95\% credible interval is 0.026 - 0.302). 

```{r fig.cap="Scatter plot showing the correlation between our two measures. Each line is a sample from the posterior of a Bayesian linear regression."}
d %>% 
  modelr::data_grid(rms = seq(-0.2, 0.8, 0.1)) %>%
  add_fitted_draws(m, n = 100) %>%
  ggplot(aes(x = rms, y = threshold, color = as.factor(index))) +
  geom_line(aes(y = .value, group = .draw), alpha = .1, colour = "thistle4") +
  geom_point(data = d) +
  theme_minimal() + 
  ggthemes::scale_colour_ptol("index")
```
